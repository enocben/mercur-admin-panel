import { useEffect, useState } from "react";

import { toast } from "@medusajs/ui";

import { useTranslation } from "react-i18next";
import { useNavigate, useParams } from "react-router-dom";

import { RouteFocusModal } from "@components/modals";

import { useOrder, useOrderPreview } from "@hooks/api";
import { useClaim, useCreateClaim } from "@hooks/api/claims";
import { useReturn } from "@hooks/api/returns";

import { ClaimCreateForm } from "@routes/orders/order-create-claim/components/claim-create-form";
import { DEFAULT_FIELDS } from "@routes/orders/order-detail/constants";

let IS_REQUEST_RUNNING = false;

export const ClaimCreate = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const { t } = useTranslation();

  const { order } = useOrder(id!, {
    fields: DEFAULT_FIELDS,
  });

  const { order: preview } = useOrderPreview(id!);
  const [activeClaimId, setActiveClaimId] = useState<string>();
  const { mutateAsync: createClaim } = useCreateClaim(order.id);

  const { claim } = useClaim(activeClaimId!, undefined, {
    enabled: !!activeClaimId,
  });
  const { return: orderReturn } = useReturn(claim?.return_id!, undefined, {
    enabled: !!claim?.return_id,
  });

  useEffect(() => {
    async function run() {
      if (IS_REQUEST_RUNNING || !preview) {
        return;
      }

      if (preview.order_change) {
        if (preview.order_change.change_type === "claim") {
          setActiveClaimId(preview.order_change.claim_id);
        } else {
          navigate(`/orders/${preview.id}`, { replace: true });
          toast.error(t("orders.claims.activeChangeError"));
        }

        return;
      }

      IS_REQUEST_RUNNING = true;

      try {
        const { claim: createdClaim } = await createClaim({
          order_id: preview.id,
          type: "replace",
        });

        setActiveClaimId(createdClaim.id);
      } catch (e) {
        toast.error(e.message);
        navigate(`/orders/${preview.id}`, { replace: true });
      } finally {
        IS_REQUEST_RUNNING = false;
      }
    }

    run();
  }, [preview]);

  return (
    <RouteFocusModal>
      {claim && preview && order && (
        <ClaimCreateForm
          order={order}
          claim={claim}
          preview={preview}
          orderReturn={orderReturn}
        />
      )}
    </RouteFocusModal>
  );
};
